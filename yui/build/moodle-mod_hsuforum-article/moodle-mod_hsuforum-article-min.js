YUI.add("moodle-mod_hsuforum-article",function(u,e){var t,r="hsuforum-thread-edit",d="hsuforum-post-edit",l={ADD_DISCUSSION:"#newdiscussionform input[type=submit]",ADD_DISCUSSION_TARGET:".hsuforum-add-discussion-target",ALL_FORMS:".hsuforum-reply-wrapper form",CONTAINER:".mod-hsuforum-posts-container",CONTAINER_LINKS:".mod-hsuforum-posts-container a",DISCUSSION:".hsuforum-thread",DISCUSSIONS:".hsuforum-threads-wrapper",DISCUSSION_EDIT:"."+r,DISCUSSION_BY_ID:'.hsuforum-thread[data-discussionid="%d"]',DISCUSSION_COUNT:".hsuforum-discussion-count",DISCUSSION_TARGET:".hsuforum-new-discussion-target",DISCUSSION_TEMPLATE:"#hsuforum-discussion-template",DISCUSSION_VIEW:".hsuforum-thread-view",EDITABLE_MESSAGE:"[contenteditable]",EDITABLE_MESSAGE_TARGET:'textarea[id^="editor-target-container"]:not([style*="display: none"])',EDITABLE_MESSAGE_ATTO:'[id^="editor-target-container"][contenteditable]:not([style*="display: none"])',FORM:".hsuforum-form",FORM_ADVANCED:".hsuforum-use-advanced",FORM_REPLY_WRAPPER:".hsuforum-reply-wrapper",INPUT_FORUM:'input[name="forum"]',INPUT_MESSAGE:'textarea[name="message"]',INPUT_REPLY:'input[name="reply"]',INPUT_SUBJECT:'input[name="subject"]',LINK_CANCEL:".hsuforum-cancel",NO_DISCUSSIONS:".forumnodiscuss",NOTIFICATION:".hsuforum-notification",OPTIONS_TO_PROCESS:".hsuforum-options-menu.unprocessed",PLACEHOLDER:".thread-replies-placeholder",POSTS:".hsuforum-thread-replies",POST_BY_ID:'.hsuforum-post-target[data-postid="%d"]',POST_EDIT:"."+d,POST_TARGET:".hsuforum-post-target",RATE:".forum-post-rating",RATE_POPUP:".forum-post-rating a",REPLY_TEMPLATE:"#hsuforum-reply-template",SEARCH_PAGE:"#page-mod-hsuforum-search",VALIDATION_ERRORS:".hsuforum-validation-errors",VIEW_POSTS:".hsuforum-view-posts"},c="discussion:created",h="discussion:deleted",f="form:canceled",m="post:created",g="post:deleted",p="post:updated";function i(){i.superclass.constructor.apply(this,arguments)}function o(){o.superclass.constructor.apply(this,arguments)}function n(){n.superclass.constructor.apply(this,arguments)}M.mod_hsuforum=M.mod_hsuforum||{},i.NAME="moodle-mod_hsuforum-dom",i.ATTRS={io:{value:null}},u.extend(i,u.Base,{initializer:function(){u.all(l.RATE).addClass("processed"),this.initOptionMenus()},initFeatures:function(){this.initOptionMenus(),this.initRatings()},initRatings:function(){u.all(l.RATE).each(function(e){e.hasClass("processed")||(M.core_rating.Y=u,e.all("select.postratingmenu").each(M.core_rating.attach_rating_events,M.core_rating),e.all("input.postratingmenusubmit").setStyle("display","none"),e.addClass("processed"))})},initOptionMenus:function(){u.all(l.OPTIONS_TO_PROCESS).each(function(e){e.removeClass("unprocessed");var t=new u.YUI2.widget.Menu(e.generateID(),{lazyLoad:!0});t.render(u.one(l.CONTAINER).generateID()),u.one("#"+e.getData("controller")).on("click",function(e){e.preventDefault(),t.cfg.setProperty("y",e.currentTarget.getY()+e.currentTarget.get("offsetHeight")),t.cfg.setProperty("x",e.currentTarget.getX()),t.show()})})},handleViewRating:function(e){null===e.currentTarget.ancestor(".helplink")&&(e.preventDefault(),openpopup(e,{url:e.currentTarget.get("href")+"&popup=1",name:"ratings",options:"height=400,width=600,top=0,left=0,menubar=0,location=0,scrollbars,resizable,toolbar,status,directories=0,fullscreen=0,dependent"}))},markPostAsRead:function(e,t,i){this.get("io").send({postid:e,action:"markread"},t,i)},incrementDiscussionCount:function(e){var t=u.one(l.DISCUSSION_COUNT);null!==t&&(t.setData("count",parseInt(t.getData("count"),10)+e),t.setHTML(M.util.get_string("xdiscussions","mod_hsuforum",t.getData("count"))))},displayNotification:function(e){var t=u.Node.create(e);u.one(l.NOTIFICATION).append(t),setTimeout(function(){t.remove(!0)},1e4)},handleNotification:function(e){u.Lang.isString(e.notificationhtml)&&0<e.notificationhtml.trim().length&&this.displayNotification(e.notificationhtml)},handleUpdateDiscussion:function(e){var t=u.one("#discussionsview");t?t.setHTML(e.html):(t=u.one(l.DISCUSSION_BY_ID.replace("%d",e.discussionid)))?(t.replace(e.html),this.initRatings()):u.one(l.DISCUSSION_TARGET).insert(e.html,"after")},handleDiscussionCreated:function(){u.one(l.NO_DISCUSSIONS)&&u.one(l.NO_DISCUSSIONS).remove()},handleDiscussionDeleted:function(e){var t=u.one(l.POST_BY_ID.replace("%d",e.postid));null!==t&&t.hasAttribute("data-isdiscussion")&&(u.one(l.DISCUSSIONS)?(t.remove(!0),this.incrementDiscussionCount(-1),u.one(l.DISCUSSION_COUNT).focus()):window.location.href=e.redirecturl)}}),M.mod_hsuforum.Dom=i,t=u.Base.create("hsuforumRouter",u.Router,[],{initializer:function(){},discussion:function(e){this.get("article").viewDiscussion(e.query.d,e.query.postid)},post:function(e){var t=M.mod_hsuforum.Article.ATTRS.contextId;window.console.log("contextId: ",t),u.Lang.isUndefined(e.query.reply)?u.Lang.isUndefined(e.query.forum)?u.Lang.isUndefined(e.query["delete"])?u.Lang.isUndefined(e.query.edit)?u.Lang.isUndefined(e.query.prune)||(window.location.href=e.url):this.get("article").get("form").showEditForm(e.query.edit):this.get("article").confirmDeletePost(e.query["delete"]):this.get("article").get("form").showAddDiscussionForm(e.query.forum):this.get("article").get("form").showReplyToForm(e.query.reply)},focusHash:function(e){var t=e.get("href").split("#");setTimeout(function(){try{u.one("#"+t[1]).ancestor("li").focus()}catch(e){}},300)},handleRoute:function(e){1!==e.button||e.ctrlKey||e.metaKey||e.currentTarget.hasClass("disable-router")||e.currentTarget.hasClass("autolink")||e.currentTarget.ancestor(".posting")?-1<e.currentTarget.get("href").indexOf("#")&&this.focusHash(e.currentTarget):this.routeUrl(e.currentTarget.get("href"))&&e.preventDefault()},routeUrl:function(e){return!!this.hasRoute(e)&&(this.save(this.removeRoot(e)),!0)},handleAddDiscussionRoute:function(e){if(e.preventDefault(),"undefined"!=typeof e.currentTarget){var t=e.currentTarget.ancestor("form"),i=t.one(l.INPUT_FORUM).get("value");this.save(t.get("action")+"?forum="+i)}},
handleViewDiscussion:function(e){var t="/discuss.php?d="+e.discussionid;u.Lang.isUndefined(e.postid)||(t=t+"&postid="+e.postid),this.save(t)},hideForms:function(e,t,i){this.get("article").get("form").removeAllForms(),i()}},{ATTRS:{article:{value:null},root:{valueFn:function(){return M.cfg.wwwroot.replace(this._regexUrlOrigin,"")+"/mod/hsuforum"}},routes:{value:[{path:"/view.php",callbacks:["hideForms"]},{path:"/discuss.php",callbacks:["hideForms","discussion"]},{path:"/post.php",callbacks:["hideForms","post"]}]}}}),M.mod_hsuforum.Router=t,o.NAME="moodle-mod_hsuforum-form",o.ATTRS={io:{value:null},editorConfig:{value:undefined}},u.extend(o,u.Base,{handlePostToGroupsToggle:function(e){var t=e.currentTarget.ancestor("form"),i=t.one("#menugroupinfo");e.currentTarget.get("checked")?i.set("disabled","disabled"):i.set("disabled","")},handleTimeToggle:function(e){e.currentTarget.get("checked")?e.currentTarget.ancestor(".fdate_time_selector").all("select").removeAttribute("disabled"):e.currentTarget.ancestor(".fdate_time_selector").all("select").setAttribute("disabled","disabled")},_displayReplyForm:function(e){var t,i,o=u.one(l.REPLY_TEMPLATE).getHTML(),n=e.one(l.FORM_REPLY_WRAPPER);n instanceof u.Node?n.replace(o):e.append(o),n=e.one(l.FORM_REPLY_WRAPPER),this.attachEditor(n),this.attachFormWarnings(),n.one(l.INPUT_REPLY).setAttribute("value",e.getData("postid")),(t=n.one(l.FORM_ADVANCED)).setAttribute("href",t.getAttribute("href").replace(/reply=\d+/,"reply="+e.getData("postid"))),i=n.one("div[id^=editor-target-container-]"),t.on("click",function(){t.setAttribute("href",t.getAttribute("href")+"&msgcontent="+i.get("textContent"))}),e.hasAttribute("data-ispost")&&n.one("legend").setHTML(M.util.get_string("replytox","mod_hsuforum",e.getData("author")))},_copyMessage:function(e){var t=e.one(l.EDITABLE_MESSAGE).get("innerHTML");null!==e.one(".editor_atto")&&(t=e.one(l.EDITABLE_MESSAGE_ATTO).get("innerHTML")),t=(t=(t=(t=(t=t.replace(/&amp;/g,"&")).replace(/&gt;/g,">")).replace(/&lt;/g,"<")).replace(/&quot;/g,'"')).replace(/&#39;/g,"'"),e.one(l.INPUT_MESSAGE).set("value",t)},_submitReplyForm:function(t,i){var e,o,n;t.all("button").setAttribute("disabled","disabled"),this._copyMessage(t),e=t.all("form input[type=file]"),(o=u.one("#hiddenadvancededitordraftid"))&&((n=o.cloneNode()).id="hiddenadvancededitordraftidclone",t.one("form input").insert(n,"before")),this.get("io").submitForm(t.one("form"),function(e){e.yuiformsubmit=1,!0===e.errors?(t.one(l.VALIDATION_ERRORS).setHTML(e.html).addClass("notifyproblem"),t.all("button").removeAttribute("disabled")):i.call(this,e)},this,0<e._nodes.length)},attachEditor:function(e){var t=l.EDITABLE_MESSAGE_TARGET+":not([contenteditable])";e||(t="article "+t),u.all(t).each(function(e){var t,i=u.guid("editor-target-container-");e.setAttribute("id",i),t=Object.assign({elementid:i,contextId:this.get("io").get("contextId")},this.get("editorConfig")),new u.M.editor_atto.Editor(t)},this)},attachFormWarnings:function(){u.all(l.ALL_FORMS).each(function(e){if(!e.hasClass("form-checker-added")){var t=M.core_formchangechecker.init({formid:e.generateID()});e.addClass("form-checker-added"),e.one(l.EDITABLE_MESSAGE).on("keypress",M.core_formchangechecker.set_form_changed,t)}})},removeAllForms:function(){u.all(l.POSTS+" "+l.FORM_REPLY_WRAPPER).each(function(e){e.ancestor(l.DISCUSSION_EDIT)||e.ancestor(l.POST_EDIT)||e.remove(!0)});var e=u.one(l.ADD_DISCUSSION_TARGET);null!==e&&e.empty(),this.attachEditor()},handleCancelForm:function(e){e.preventDefault();var t=e.target.ancestor(l.POST_TARGET);if(!t)return t=e.target.ancestor(l.ADD_DISCUSSION_TARGET),void e.target.ancestor(l.FORM_REPLY_WRAPPER).remove(!0);t.removeClass(d).removeClass(r),e.target.ancestor(l.FORM_REPLY_WRAPPER).remove(!0),this.fire(f,{discussionid:t.getData("discussionid"),postid:t.getData("postid")})},handleFormSubmit:function(e){e.preventDefault();var t=e.currentTarget.ancestor(l.FORM_REPLY_WRAPPER);this._submitReplyForm(t,function(e){switch(e.eventaction){case"postupdated":case"postcreated":this.fire(p,e);break;case"discussioncreated":this.fire(c,e)}})},sendInProgressData:function(e){var t=u.one("div[id^=editor-target-container-]"),i=u.one("input[name=subject]"),o=e.target.getAttribute("href");o.includes("post.php?edit")||e.target.setAttribute("href",e.target.getAttribute("href")+"&msgcontent="+t.get("textContent")+"&subcontent="+i.get("value"))},showReplyToForm:function(e){var t=u.one(l.POST_BY_ID.replace("%d",e));t.hasAttribute("data-ispost")&&this._displayReplyForm(t),t.one(l.EDITABLE_MESSAGE).focus()},setDateField:function(e,t,i){var o=new Date(1e3*i),n=o.getMinutes(),s=o.getHours(),a=o.getDate(),r=o.getMonth()+1,d=o.getFullYear();t?u.one("#id_time"+e+"_enabled").set("checked",!0):u.one("#id_time"+e+"_enabled").set("checked",!1),0<n&&60==(n=5*Math.round(n/5))&&(n=55),u.one("#id_time"+e+"_minute").set("value",n),u.one("#id_time"+e+"_hour").set("value",s),u.one("#id_time"+e+"_day").set("value",a),u.one("#id_time"+e+"_month").set("value",r),u.one("#id_time"+e+"_year").set("value",d),this.setDateFieldsClassState()},resetDateField:function(e){if(u.one("#discussion_dateform fieldset")){var t=Math.floor(Date.now()/1e3);this.setDateField(e,!1,t)}},resetDateFields:function(){var e,t=["start","end"];for(e in t)this.resetDateField(t[e])},setDateFieldsClassState:function(){var e=u.one("fieldset.dateform_fieldset");e&&e.all(".fdate_selector").each(function(e){e.one("input").get("checked")?e.all("select").removeAttribute("disabled"):e.all("select").setAttribute("disabled","disabled")})},applyDateFields:function(){var o,e,t,i,n;if(u.one(".dateformtarget")){if((o=u.one("#discussion_dateform fieldset"))||((o=u.Node.create("<fieldset/>")).addClass("form-inline"),(e=u.all("#discussion_dateform div.row.fitem"))._nodes&&0!==e._nodes.length||(t=u.all("#discussion_dateform .form-inline.felement"),i=u.all(".col-form-label.d-inline"),n=[],i.each(function(e){n.push(e.ancestor())}),t.each(function(e,t){if(0<t){var i=u.Node.create("<div/>"
);i.addClass("form-group"),o.appendChild(i),i.appendChild(n[t-1]).addClass("row"),i.appendChild(e).addClass("row")}})),e.each(function(e,t){0<t&&o.appendChild(e)})),!o)return;o.addClass("dateform_fieldset"),o.removeClass("hidden"),o.one("legend")&&o.one("legend").remove(),o.all("a.visibleifjs").addClass("disable-router"),u.one(".dateformtarget").append(o)}this.setDateFieldsClassState()},setDateFields:function(e,t){0==e&&this.resetDateField("start"),0==t&&this.resetDateField("end")},setDefaultDateSettings:function(){var e=u.one("#id_timestart_enabled").ancestor(".felement"),t=u.one("#id_timeend_enabled").ancestor(".felement");e.all("select").setAttribute("disabled","disabled"),t.all("select").setAttribute("disabled","disabled")},showAddDiscussionForm:function(){var e,t,i,o=u.one(l.ADD_DISCUSSION_TARGET).setHTML(u.one(l.DISCUSSION_TEMPLATE).getHTML()).one(l.INPUT_SUBJECT).focus();this.resetDateFields(),this.applyDateFields(),this.attachEditor(o),this.attachFormWarnings();try{this.setDefaultDateSettings()}catch(n){}e=u.one(l.FORM_ADVANCED),t=u.one("div[id^=editor-target-container-]"),i=u.one("input[name=subject]"),e.on("click",function(){e.setAttribute("href",e.getAttribute("href")+"&msgcontent="+t.get("textContent")+"&subcontent="+i.get("value"))})},showEditForm:function(e){var s,t,a=u.one(l.POST_BY_ID.replace("%d",e));a.hasClass(r)||a.hasClass(d)?a.one(l.EDITABLE_MESSAGE).focus():(s=this,t=u.one("#hiddenadvancededitordraftid"),this.get("io").send({discussionid:a.getData("discussionid"),postid:a.getData("postid"),draftid:t?t.get("value"):0,action:"edit_post_form"},function(e){var t,i,o,n;a.prepend(e.html),a.hasAttribute("data-isdiscussion")?a.addClass(r):a.addClass(d),this.attachEditor(a),a.one(l.EDITABLE_MESSAGE).focus(),e.isdiscussion&&(s.applyDateFields(),t=e.offset,0!=e.timestart||0!=e.timeend?(i=60*(new Date).getTimezoneOffset(),o=parseInt(e.timestart)+parseInt(i)+parseInt(t),n=parseInt(e.timeend)+parseInt(i)+parseInt(t),s.setDateFields(o,n)):s.setDateFields(e.timestart,e.timeend)),this.attachFormWarnings()},this))}}),M.mod_hsuforum.Form=o,n.NAME=e,n.ATTRS={contextId:{value:undefined},editorConfig:{value:undefined},io:{readOnly:!0},dom:{readOnly:!0},router:{readOnly:!0},form:{readOnly:!0},liveLog:{readOnly:!0},currentEditLink:null},u.extend(n,u.Base,{initializer:function(){this._set("router",new M.mod_hsuforum.Router({article:this,html5:!1})),this._set("io",new M.mod_hsuforum.Io({contextId:this.get("contextId")})),this._set("dom",new M.mod_hsuforum.Dom({io:this.get("io")})),this._set("form",new M.mod_hsuforum.Form({io:this.get("io"),editorConfig:this.get("editorConfig")})),this._set("liveLog",M.mod_hsuforum.init_livelog()),this.bind()},bind:function(){var e,t,i,o,n,s,a,r=document.getElementsByClassName("hsuforum-post-unread")[0];if(r&&"#unread"===location.hash){if(e=document.getElementById(r.id).parentNode,navigator.userAgent.match(/Trident|MSIE/)){for(t=e.offsetTop,i=e;i=i.offsetParent;)t+=i.offsetTop;window.scrollTo(0,t)}else e.scrollIntoView();e.focus()}null===u.one(l.SEARCH_PAGE)&&(o=this.get("dom"),n=this.get("form"),s=this.get("router"),a='.hsuforum-discussion input[name="posttomygroups"]',u.delegate("click",n.handlePostToGroupsToggle,document,a,n),u.delegate("click",n.handleTimeToggle,document,"#id_timestart_enabled",n),u.delegate("click",n.handleTimeToggle,document,"#id_timeend_enabled",n),u.delegate("click",n.handleCancelForm,document,l.LINK_CANCEL,n),u.delegate("click",s.handleRoute,document,l.CONTAINER_LINKS,s),u.delegate("click",o.handleViewRating,document,l.RATE_POPUP,o),u.delegate("submit",n.handleFormSubmit,document,l.FORM,n),u.delegate("click",s.handleAddDiscussionRoute,document,l.ADD_DISCUSSION,s),u.delegate("click",n.sendInProgressData,document,l.FORM_ADVANCED,n),n.on(m,o.handleUpdateDiscussion,o),n.on(m,o.handleNotification,o),n.on(m,s.handleViewDiscussion,s),n.on(m,this.handleLiveLog,this),n.on(p,this.handlePostUpdated,this),n.on(c,o.handleUpdateDiscussion,o),n.on(c,o.handleDiscussionCreated,o),n.on(c,o.handleNotification,o),n.on(c,s.handleViewDiscussion,s),n.on(c,this.handleLiveLog,this),this.on(h,o.handleDiscussionDeleted,o),this.on(h,o.handleNotification,o),this.on(h,this.handleLiveLog,this),this.on(g,o.handleUpdateDiscussion,o),this.on(g,s.handleViewDiscussion,s),this.on(g,o.handleNotification,o),this.on(g,this.handleLiveLog,this),n.on(f,s.handleViewDiscussion,s),n.attachEditor(this.get("contextId")))},handlePostUpdated:function(e){var t=this.get("dom"),i=this.get("router");t.handleUpdateDiscussion(e),i.handleViewDiscussion(e),t.handleNotification(e),this.handleLiveLog(e)},handleLiveLog:function(e){u.Lang.isString(e.livelog)&&this.get("liveLog").logText(e.livelog)},viewDiscussion:function(e,t){var i,o=u.one(l.DISCUSSION_BY_ID.replace("%d",e));o instanceof u.Node&&(u.Lang.isUndefined(t)||null===(i=u.one(l.POST_BY_ID.replace("%d",t)))||i.hasAttribute("data-isdiscussion")?o.focus():i.get("parentNode").focus())},confirmDeletePost:function(e){null!==u.one(l.POST_BY_ID.replace("%d",e))&&!0===window.confirm(M.str.mod_hsuforum.deletesure)&&this.deletePost(e)},deletePost:function(e){var t=u.one(l.POST_BY_ID.replace("%d",e));null!==t&&this.get("io").send({postid:e,sesskey:M.cfg.sesskey,action:"delete_post"},function(e){t.hasAttribute("data-isdiscussion")?this.fire(h,e):this.fire(g,e)},this)}}),M.mod_hsuforum.Article=n,M.mod_hsuforum.init_article=function(e){new n(e)},M.mod_hsuforum.dispatchClick=function(e){if(document.createEvent){var t=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0});e.dispatchEvent(t)}else e.fireEvent&&e.fireEvent("onclick")}},"@VERSION@",{requires:["base","node","event","router","core_rating","querystring","moodle-editor_atto-editor","moodle-mod_hsuforum-io","moodle-mod_hsuforum-livelog","moodle-core-formchangechecker"]});